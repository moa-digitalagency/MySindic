<!--
Shabaka Syndic - Solution compl√®te et digitale pour les syndics et r√©sidents au Maroc.

Shabaka Syndic
Par : Aisance KALONJI
Mail : moa@myoneart.com
www.myoneart.com
-->
{% extends "admin/admin_base.html" %}

{% block title %}Gestion Maintenance - Shabaka Syndic{% endblock %}

{% block admin_content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-gray-900">Gestion de la Maintenance</h1>
            <p class="mt-2 text-sm text-gray-700">Toutes les demandes de maintenance des r√©sidences</p>
        </div>
        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
            <button onclick="ShabakaSyndic.openModal('announcementModal')" class="btn-primary">
                + Nouvelle Annonce
            </button>
        </div>
    </div>

    <div class="mt-8">
        <div class="card">
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="label-field">Filtrer par r√©sidence</label>
                    <select id="filter-residence" class="input-field" onchange="filterRequests()">
                        <option value="">Toutes les r√©sidences</option>
                    </select>
                </div>
                <div>
                    <label class="label-field">Filtrer par statut</label>
                    <select id="filter-status" class="input-field" onchange="filterRequests()">
                        <option value="">Tous</option>
                        <option value="pending">En attente</option>
                        <option value="in_progress">En cours</option>
                        <option value="resolved">R√©solu</option>
                        <option value="rejected">Rejet√©</option>
                    </select>
                </div>
                <div>
                    <label class="label-field">Filtrer par priorit√©</label>
                    <select id="filter-priority" class="input-field" onchange="filterRequests()">
                        <option value="">Toutes</option>
                        <option value="urgent">Urgent</option>
                        <option value="high">Haute</option>
                        <option value="medium">Normale</option>
                        <option value="low">Basse</option>
                    </select>
                </div>
            </div>
            
            <div id="maintenance-list" class="overflow-x-auto">
                <div class="flex justify-center py-8">
                    <div class="loading-spinner border-indigo-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal D√©tails & Mise √† jour -->
<div id="maintenanceModal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" id="modal-title">D√©tails de la demande</h2>
                <button onclick="ShabakaSyndic.closeModal('maintenanceModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="maintenance-details" class="space-y-4">
                <div class="flex justify-center py-8">
                    <div class="loading-spinner border-indigo-600"></div>
                </div>
            </div>
            
            <!-- Section Commentaires -->
            <div id="comments-section" class="mt-6 border-t pt-6">
                <h3 class="font-medium text-gray-900 mb-4">üí¨ Commentaires & Communication</h3>
                
                <div id="comments-list" class="space-y-3 mb-4">
                    <!-- Les commentaires seront charg√©s ici -->
                </div>
                
                <form id="commentForm" class="mt-4">
                    <input type="hidden" id="comment-request-id">
                    <div>
                        <label class="label-field">Ajouter un commentaire</label>
                        <textarea id="comment-text" class="input-field" rows="3" placeholder="√âcrivez votre commentaire..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-field">Taguer un r√©sident</label>
                            <select id="comment-mention" class="input-field">
                                <option value="">Aucun</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center">
                                <input type="checkbox" id="comment-internal" class="rounded-[10px] border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-2 text-sm text-gray-700">Commentaire interne (admins seulement)</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-end">
                        <button type="submit" class="btn-primary">Publier le commentaire</button>
                    </div>
                </form>
            </div>
            
            <form id="updateForm" class="space-y-4 mt-6 border-t pt-6">
                <input type="hidden" id="request-id">
                
                <h3 class="font-medium text-gray-900">Mise √† jour</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-field">Statut</label>
                        <select id="update-status" class="input-field">
                            <option value="pending">En attente</option>
                            <option value="in_progress">En cours</option>
                            <option value="completed">Termin√©</option>
                            <option value="cancelled">Annul√©</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-field">Date intervention</label>
                        <input type="datetime-local" id="update-scheduled" class="input-field">
                    </div>
                </div>
                
                <div>
                    <label class="label-field">Assign√© √†</label>
                    <input type="text" id="update-assigned" class="input-field" placeholder="Nom du technicien/entreprise">
                </div>
                
                <div>
                    <label class="label-field">Notes administrateur</label>
                    <textarea id="update-notes" class="input-field" rows="3"></textarea>
                </div>
                
                <div>
                    <label class="label-field">Notes de r√©solution</label>
                    <textarea id="update-resolution" class="input-field" rows="3" placeholder="Travaux effectu√©s, pi√®ces remplac√©es..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="ShabakaSyndic.closeModal('maintenanceModal')" class="btn-secondary">
                        Fermer
                    </button>
                    <button type="submit" class="btn-primary">
                        Mettre √† jour
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nouvelle Annonce -->
<div id="announcementModal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Nouvelle Annonce de Maintenance</h2>
                <button onclick="ShabakaSyndic.closeModal('announcementModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="announcementForm" class="space-y-4">
                <div>
                    <label class="label-field">R√©sidence *</label>
                    <select id="announcement-residence" class="input-field" required>
                        <option value="">S√©lectionner une r√©sidence</option>
                    </select>
                </div>
                
                <div>
                    <label class="label-field">Titre *</label>
                    <input type="text" id="announcement-title" class="input-field" required>
                </div>
                
                <div>
                    <label class="label-field">Description *</label>
                    <textarea id="announcement-description" class="input-field" rows="4" required></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-field">Zone *</label>
                        <select id="announcement-zone" class="input-field" required>
                            <option value="general">G√©n√©ral</option>
                            <option value="escalier">Escalier</option>
                            <option value="ascenseur">Ascenseur</option>
                            <option value="parking">Parking</option>
                            <option value="jardin">Jardin</option>
                            <option value="toiture">Toiture</option>
                            <option value="facade">Fa√ßade</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-field">Priorit√©</label>
                        <select id="announcement-priority" class="input-field">
                            <option value="medium">Normale</option>
                            <option value="high">Haute</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="label-field">Date d'intervention pr√©vue</label>
                    <input type="datetime-local" id="announcement-scheduled" class="input-field">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="ShabakaSyndic.closeModal('announcementModal')" class="btn-secondary">
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary">
                        Cr√©er l'annonce
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
let allRequests = [];

async function loadMaintenanceRequests() {
    try {
        const response = await fetch('/api/admin/maintenance', { credentials: 'same-origin' });
        
        if (!response.ok) {
            const container = document.getElementById('maintenance-list');
            container.innerHTML = `<p class="text-center text-red-600 py-8">Erreur: ${response.status === 401 ? 'Authentification requise' : 'Impossible de charger les donn√©es'}</p>`;
            ShabakaSyndic.showToast('Erreur lors du chargement', 'error');
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            allRequests = data.maintenance_requests;
            loadResidenceFilter();
            filterRequests();
        } else {
            const container = document.getElementById('maintenance-list');
            container.innerHTML = `<p class="text-center text-red-600 py-8">Erreur: ${data.error || 'Une erreur est survenue'}</p>`;
            ShabakaSyndic.showToast(data.error || 'Erreur lors du chargement', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        const container = document.getElementById('maintenance-list');
        container.innerHTML = '<p class="text-center text-red-600 py-8">Erreur de connexion au serveur</p>';
        ShabakaSyndic.showToast('Erreur de connexion', 'error');
    }
}

async function loadResidenceFilter() {
    try {
        const response = await fetch('/api/admin/residences', { credentials: 'same-origin' });
        const data = await response.json();
        if (data.success) {
            const residenceSelect = document.getElementById('filter-residence');
            const announcementSelect = document.getElementById('announcement-residence');
            data.residences.forEach(r => {
                residenceSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                announcementSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading residences:', error);
    }
}

function filterRequests() {
    const residenceFilter = document.getElementById('filter-residence').value;
    const statusFilter = document.getElementById('filter-status').value;
    const priorityFilter = document.getElementById('filter-priority').value;
    
    let filtered = allRequests;
    
    if (residenceFilter) {
        filtered = filtered.filter(r => r.residence_id == residenceFilter);
    }
    
    if (statusFilter) {
        filtered = filtered.filter(r => r.status === statusFilter);
    }
    
    if (priorityFilter) {
        filtered = filtered.filter(r => r.priority === priorityFilter);
    }
    
    displayRequests(filtered);
}

function displayRequests(requestsList) {
    const container = document.getElementById('maintenance-list');
    
    if (requestsList.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune demande trouv√©e</p>';
        return;
    }
    
    const getPriorityColor = (priority) => {
        switch(priority) {
            case 'urgent': return 'badge-danger';
            case 'high': return 'badge-warning';
            case 'normal': return 'badge-info';
            default: return 'badge-success';
        }
    };
    
    const getStatusColor = (status) => {
        switch(status) {
            case 'pending': return 'badge-warning';
            case 'in_progress': return 'badge-info';
            case 'completed': return 'badge-success';
            default: return 'badge-danger';
        }
    };
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>R√©sidence</th>
                    <th>Demandeur</th>
                    <th>Priorit√©</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${requestsList.map(r => `
                    <tr>
                        <td>
                            <div class="font-medium text-gray-900">${r.title}</div>
                            <div class="text-xs text-gray-500">N¬∞ ${r.tracking_number}</div>
                        </td>
                        <td>${r.residence_name || '-'}</td>
                        <td>
                            <div class="text-sm">${r.author_name || '-'}</div>
                            ${r.zone_details ? `<div class="text-xs text-gray-500">${r.zone_details}</div>` : ''}
                        </td>
                        <td><span class="badge ${getPriorityColor(r.priority)}">${r.priority}</span></td>
                        <td><span class="badge ${getStatusColor(r.status)}">${r.status}</span></td>
                        <td class="text-sm">${ShabakaSyndic.formatDate(r.created_at)}</td>
                        <td>
                            <button onclick="viewRequest(${r.id})" style="padding: 0.375rem 0.75rem; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.05); color: #667eea; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.05)'">
                                G√©rer
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

async function viewRequest(requestId) {
    const request = allRequests.find(r => r.id === requestId);
    if (!request) return;
    
    document.getElementById('modal-title').textContent = request.title;
    document.getElementById('request-id').value = request.id;
    document.getElementById('comment-request-id').value = request.id;
    
    const details = `
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="text-sm font-medium text-gray-500">R√©sidence</label>
                <p class="mt-1 text-gray-900">${request.residence_name || '-'}</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Demandeur</label>
                <p class="mt-1 text-gray-900">${request.author_name || '-'} (${request.author_role || 'N/A'})</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Zone</label>
                <p class="mt-1 text-gray-900">${request.zone || '-'}</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Localisation</label>
                <p class="mt-1 text-gray-900">${request.zone_details || '-'}</p>
            </div>
            <div class="col-span-2">
                <label class="text-sm font-medium text-gray-500">Description</label>
                <p class="mt-1 text-gray-900">${request.description}</p>
            </div>
            ${request.image_path ? `
                <div class="col-span-2">
                    <label class="text-sm font-medium text-gray-500">Photo jointe</label>
                    <div class="mt-2">
                        <img src="${request.image_path}" alt="Photo" class="rounded-[10px]-[10px] max-h-64 border border-gray-300" />
                    </div>
                </div>
            ` : ''}
            <div>
                <label class="text-sm font-medium text-gray-500">N¬∞ de suivi</label>
                <p class="mt-1 text-gray-900 font-mono">${request.tracking_number}</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Cr√©√©e le</label>
                <p class="mt-1 text-gray-900">${ShabakaSyndic.formatDate(request.created_at)}</p>
            </div>
            ${request.assigned_to ? `
                <div>
                    <label class="text-sm font-medium text-gray-500">Assign√©e √†</label>
                    <p class="mt-1 text-gray-900">${request.assigned_to}</p>
                </div>
            ` : ''}
            ${request.scheduled_date ? `
                <div>
                    <label class="text-sm font-medium text-gray-500">Intervention pr√©vue</label>
                    <p class="mt-1 text-gray-900">${ShabakaSyndic.formatDate(request.scheduled_date)}</p>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('maintenance-details').innerHTML = details;
    
    document.getElementById('update-status').value = request.status;
    document.getElementById('update-assigned').value = request.assigned_to || '';
    document.getElementById('update-notes').value = request.admin_notes || '';
    document.getElementById('update-resolution').value = request.resolution_notes || '';
    
    if (request.scheduled_date) {
        const date = new Date(request.scheduled_date);
        document.getElementById('update-scheduled').value = date.toISOString().slice(0, 16);
    } else {
        document.getElementById('update-scheduled').value = '';
    }
    
    // Charger les commentaires
    loadComments(requestId);
    
    // Charger la liste des r√©sidents pour le tag
    loadResidentsForTag(request.residence_id);
    
    ShabakaSyndic.openModal('maintenanceModal');
}

async function loadComments(requestId) {
    try {
        const response = await fetch(`/api/admin/maintenance/${requestId}/comments`, { credentials: 'same-origin' });
        const data = await response.json();
        
        if (data.success) {
            displayComments(data.comments);
        }
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

function displayComments(comments) {
    const container = document.getElementById('comments-list');
    
    if (!comments || comments.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun commentaire pour le moment</p>';
        return;
    }
    
    container.innerHTML = comments.map(comment => `
        <div class="bg-gray-50 rounded-[10px]-[10px] p-3 ${comment.is_internal ? 'border-l-4 border-yellow-400' : ''}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-sm text-gray-900">${comment.author_name || 'Inconnu'}</span>
                        <span class="text-xs text-gray-500">(${comment.author_role || 'N/A'})</span>
                        ${comment.is_internal ? '<span class="badge badge-warning text-xs">Interne</span>' : ''}
                        ${comment.comment_type === 'mention' ? '<span class="badge badge-info text-xs">Mention</span>' : ''}
                    </div>
                    <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap">${comment.comment_text}</p>
                    ${comment.mentioned_user_name ? `<p class="mt-1 text-xs text-indigo-600">@${comment.mentioned_user_name}</p>` : ''}
                </div>
                <span class="text-xs text-gray-500">${ShabakaSyndic.formatDate(comment.created_at)}</span>
            </div>
        </div>
    `).join('');
}

async function loadResidentsForTag(residenceId) {
    try {
        const response = await fetch(`/api/admin/users?residence_id=${residenceId}`, { credentials: 'same-origin' });
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('comment-mention');
            select.innerHTML = '<option value="">Aucun</option>';
            data.users.forEach(user => {
                if (user.role === 'resident' || user.role === 'owner') {
                    select.innerHTML += `<option value="${user.id}">${user.first_name} ${user.last_name} (${user.role})</option>`;
                }
            });
        }
    } catch (error) {
        console.error('Error loading residents:', error);
    }
}

document.getElementById('updateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const requestId = document.getElementById('request-id').value;
    const formData = {
        status: document.getElementById('update-status').value,
        assigned_to: document.getElementById('update-assigned').value,
        scheduled_date: document.getElementById('update-scheduled').value || null,
        admin_notes: document.getElementById('update-notes').value,
        resolution_notes: document.getElementById('update-resolution').value
    };
    
    try {
        const response = await fetch(`/api/admin/maintenance/${requestId}`, {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            ShabakaSyndic.showToast('Demande mise √† jour', 'success');
            ShabakaSyndic.closeModal('maintenanceModal');
            loadMaintenanceRequests();
        } else {
            ShabakaSyndic.showToast(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        ShabakaSyndic.showToast('Erreur de connexion', 'error');
    }
});

document.getElementById('announcementForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        residence_id: parseInt(document.getElementById('announcement-residence').value),
        title: document.getElementById('announcement-title').value,
        description: document.getElementById('announcement-description').value,
        zone: document.getElementById('announcement-zone').value,
        priority: document.getElementById('announcement-priority').value,
        scheduled_date: document.getElementById('announcement-scheduled').value || null
    };
    
    try {
        const response = await fetch('/api/admin/maintenance/announcement', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            ShabakaSyndic.showToast('Annonce cr√©√©e avec succ√®s', 'success');
            ShabakaSyndic.closeModal('announcementModal');
            document.getElementById('announcementForm').reset();
            loadMaintenanceRequests();
        } else {
            ShabakaSyndic.showToast(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        ShabakaSyndic.showToast('Erreur de connexion', 'error');
    }
});

document.getElementById('commentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const requestId = document.getElementById('comment-request-id').value;
    const commentText = document.getElementById('comment-text').value.trim();
    
    if (!commentText) {
        ShabakaSyndic.showToast('Le commentaire ne peut pas √™tre vide', 'error');
        return;
    }
    
    const formData = {
        comment_text: commentText,
        mentioned_user_id: document.getElementById('comment-mention').value || null,
        is_internal: document.getElementById('comment-internal').checked,
        comment_type: document.getElementById('comment-mention').value ? 'mention' : 'comment'
    };
    
    try {
        const response = await fetch(`/api/admin/maintenance/${requestId}/comments`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            ShabakaSyndic.showToast('Commentaire ajout√©', 'success');
            document.getElementById('comment-text').value = '';
            document.getElementById('comment-mention').value = '';
            document.getElementById('comment-internal').checked = false;
            loadComments(requestId);
        } else {
            ShabakaSyndic.showToast(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        ShabakaSyndic.showToast('Erreur de connexion', 'error');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    loadMaintenanceRequests();
});
</script>
{% endblock %}
