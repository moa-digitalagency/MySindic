{% extends "admin/admin_base.html" %}

{% block title %}Gestion des Actualit√©s - MySindic{% endblock %}

{% block admin_content %}
<div class="content-card">
    <div class="card-header">
        <div>
            <h1 class="page-title">üì∞ Gestion des Actualit√©s</h1>
            <p class="page-subtitle">Publiez et g√©rez les actualit√©s de toutes les r√©sidences</p>
        </div>
        <button onclick="openCreateModal()" class="btn-primary">
            ‚ûï Nouvelle Actualit√©
        </button>
    </div>

    <!-- Filters -->
    <div class="mb-4">
        <div class="flex flex-wrap gap-2">
            <button onclick="filterByCategory('')" id="filter-all" class="btn-filter btn-filter-active">
                Toutes
            </button>
            <button onclick="filterByCategory('info')" id="filter-info" class="btn-filter">
                Info
            </button>
            <button onclick="filterByCategory('announcement')" id="filter-announcement" class="btn-filter">
                Annonce
            </button>
            <button onclick="filterByCategory('warning')" id="filter-warning" class="btn-filter">
                Alerte
            </button>
            <button onclick="filterByCategory('maintenance')" id="filter-maintenance" class="btn-filter">
                Travaux
            </button>
        </div>
    </div>

    <div id="news-list" class="space-y-4">
        <div class="flex justify-center py-8">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<!-- Modal Cr√©er/√âditer Actualit√© -->
<div id="newsModal" class="modal-backdrop hidden">
    <div class="modal-content" style="max-width: 600px;">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="modal-title">Nouvelle Actualit√©</h2>
                <button onclick="closeModal()" class="icon-btn">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="newsForm" class="space-y-4">
                <input type="hidden" id="newsId">
                
                <div>
                    <label class="label-field">R√©sidence *</label>
                    <select id="residence_id" required class="input-field">
                        <option value="">S√©lectionner une r√©sidence</option>
                    </select>
                </div>
                
                <div>
                    <label class="label-field">Titre *</label>
                    <input type="text" id="title" required class="input-field" placeholder="Titre de l'actualit√©">
                </div>
                
                <div>
                    <label class="label-field">Cat√©gorie *</label>
                    <select id="category" required class="input-field">
                        <option value="info">Info</option>
                        <option value="announcement">Annonce</option>
                        <option value="warning">Alerte</option>
                        <option value="maintenance">Travaux</option>
                    </select>
                </div>
                
                <div>
                    <label class="label-field">Contenu *</label>
                    <textarea id="content" required rows="6" class="input-field" placeholder="Contenu de l'actualit√©"></textarea>
                </div>
                
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_important" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">‚òÖ Important</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" id="is_pinned" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">üìå √âpingler</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" id="is_published" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">Publier</span>
                    </label>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">
                        <span id="submit-text">Cr√©er</span>
                    </button>
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: #4F46E5;
    color: white;
    border: 2px solid #4F46E5;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary:hover {
    background: #4338CA;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: white;
    color: #6B7280;
    border: 2px solid #E5E7EB;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: #F9FAFB;
    border-color: #D1D5DB;
}

.btn-filter {
    padding: 0.5rem 1rem;
    background: white;
    color: #6B7280;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-filter:hover {
    border-color: #4F46E5;
    color: #4F46E5;
}

.btn-filter-active {
    background: #4F46E5;
    color: white;
    border-color: #4F46E5;
}

.btn-action {
    padding: 0.5rem 0.875rem;
    background: white;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
}

.btn-action:hover {
    background: #F9FAFB;
}

.btn-action.danger {
    color: #DC2626;
    border-color: #FCA5A5;
}

.btn-action.danger:hover {
    background: #FEE2E2;
}
</style>
{% endblock %}

{% block admin_extra_js %}
<script>
let allNews = [];
let currentCategory = '';
let editingNewsId = null;

async function loadResidences() {
    try {
        const response = await fetch('/api/admin/residences');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('residence_id');
            select.innerHTML = '<option value="">S√©lectionner une r√©sidence</option>';
            data.residences.forEach(res => {
                select.innerHTML += `<option value="${res.id}">${res.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadNews() {
    try {
        const response = await fetch('/api/admin/news');
        const data = await response.json();
        
        if (data.success) {
            allNews = data.news || [];
            filterByCategory(currentCategory);
        } else {
            MySindic.showToast('Erreur lors du chargement', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

function filterByCategory(category) {
    currentCategory = category;
    
    document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn-filter-active');
    });
    
    const activeBtn = category ? document.getElementById(`filter-${category}`) : document.getElementById('filter-all');
    if (activeBtn) {
        activeBtn.classList.add('btn-filter-active');
    }
    
    const filtered = category ? allNews.filter(n => n.category === category) : allNews;
    displayNews(filtered);
}

function displayNews(newsList) {
    const container = document.getElementById('news-list');
    
    if (newsList.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucune actualit√©</h3>
                <p class="mt-1 text-sm text-gray-500">Aucune actualit√© n'est disponible pour le moment.</p>
            </div>
        `;
        return;
    }
    
    const getCategoryIcon = (category) => {
        switch(category) {
            case 'info': return '‚ÑπÔ∏è';
            case 'announcement': return 'üì¢';
            case 'warning': return '‚ö†Ô∏è';
            case 'maintenance': return 'üîß';
            default: return 'üìÑ';
        }
    };
    
    const getCategoryColor = (category) => {
        switch(category) {
            case 'info': return 'bg-blue-100 text-blue-700';
            case 'announcement': return 'bg-green-100 text-green-700';
            case 'warning': return 'bg-yellow-100 text-yellow-700';
            case 'maintenance': return 'bg-red-100 text-red-700';
            default: return 'bg-gray-100 text-gray-700';
        }
    };
    
    let html = newsList.map(news => `
        <div class="card">
            <div class="flex items-start">
                <div class="flex-shrink-0 text-3xl mr-4">
                    ${getCategoryIcon(news.category)}
                </div>
                <div class="flex-1">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                ${news.is_important ? '<span class="text-red-500 font-bold">‚òÖ</span>' : ''}
                                ${news.is_pinned ? '<span class="text-indigo-500">üìå</span>' : ''}
                                <h3 class="text-lg font-semibold text-gray-900">${news.title}</h3>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">R√©sidence: ${news.residence_name || 'N/A'}</p>
                            <p class="mt-2 text-gray-600 line-clamp-2">${news.content}</p>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${getCategoryColor(news.category)} ml-4">
                            ${news.category}
                        </span>
                    </div>
                    
                    <div class="mt-4 flex items-center justify-between text-sm text-gray-500">
                        <div class="flex items-center space-x-4">
                            <span>üìÖ ${MySindic.formatDate(news.published_at || news.created_at)}</span>
                            ${news.author_name ? `<span>‚úçÔ∏è ${news.author_name}</span>` : ''}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs ${news.is_published ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                ${news.is_published ? '‚úì Publi√©' : 'üîí Brouillon'}
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editNews(${news.id})" class="btn-action">
                                ‚úèÔ∏è √âditer
                            </button>
                            <button onclick="deleteNews(${news.id})" class="btn-action danger">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function openCreateModal() {
    editingNewsId = null;
    document.getElementById('modal-title').textContent = 'Nouvelle Actualit√©';
    document.getElementById('submit-text').textContent = 'Cr√©er';
    document.getElementById('newsForm').reset();
    document.getElementById('is_published').checked = true;
    document.getElementById('newsModal').classList.remove('hidden');
}

async function editNews(id) {
    try {
        const news = allNews.find(n => n.id === id);
        if (!news) return;
        
        editingNewsId = id;
        document.getElementById('modal-title').textContent = '√âditer l\'Actualit√©';
        document.getElementById('submit-text').textContent = 'Mettre √† jour';
        
        document.getElementById('residence_id').value = news.residence_id;
        document.getElementById('title').value = news.title;
        document.getElementById('category').value = news.category;
        document.getElementById('content').value = news.content;
        document.getElementById('is_important').checked = news.is_important;
        document.getElementById('is_pinned').checked = news.is_pinned;
        document.getElementById('is_published').checked = news.is_published;
        
        document.getElementById('newsModal').classList.remove('hidden');
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur lors du chargement', 'error');
    }
}

function closeModal() {
    document.getElementById('newsModal').classList.add('hidden');
}

async function deleteNews(id) {
    if (!confirm('Voulez-vous vraiment supprimer cette actualit√© ?')) return;
    
    try {
        const response = await fetch(`/api/admin/news/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast('Actualit√© supprim√©e', 'success');
            loadNews();
        } else {
            MySindic.showToast(data.error || 'Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

document.getElementById('newsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        residence_id: document.getElementById('residence_id').value,
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        content: document.getElementById('content').value,
        is_important: document.getElementById('is_important').checked,
        is_pinned: document.getElementById('is_pinned').checked,
        is_published: document.getElementById('is_published').checked
    };
    
    try {
        const url = editingNewsId ? `/api/admin/news/${editingNewsId}` : '/api/admin/news';
        const method = editingNewsId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast(editingNewsId ? 'Actualit√© mise √† jour' : 'Actualit√© cr√©√©e', 'success');
            closeModal();
            loadNews();
        } else {
            MySindic.showToast(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    loadResidences();
    loadNews();
});
</script>
{% endblock %}
