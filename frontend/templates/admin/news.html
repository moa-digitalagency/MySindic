<!--
MySindic - Solution compl√®te et digitale pour les syndics et r√©sidents au Maroc.

Shabaka Syndic
Par : Aisance KALONJI
Mail : moa@myoneart.com
www.myoneart.com
-->
{% extends "admin/admin_base.html" %}

{% block title %}Actualit√©s - MySindic{% endblock %}

{% block admin_content %}
<div class="content-card">
    <div class="card-header">
        <div>
            <h1 class="page-title">üì∞ Fil d'Actualit√©</h1>
            <p class="page-subtitle">Derni√®res nouvelles de toutes les r√©sidences</p>
        </div>
    </div>

    <!-- Zone de publication -->
    <div style="padding: 1rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1.5rem;">
        <select id="residence_id" required style="width: 100%; padding: 0.625rem; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; margin-bottom: 0.75rem; background: white; outline: none;">
            <option value="">S√©lectionner une r√©sidence...</option>
        </select>
        
        <input type="text" id="news-title" placeholder="Titre de l'actualit√©..." style="width: 100%; padding: 0.625rem; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; margin-bottom: 0.75rem; background: white; outline: none;">
        
        <textarea id="news-content" placeholder="Contenu de l'actualit√©..." style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; resize: vertical; min-height: 100px; outline: none; background: white;"></textarea>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem;">
            <div style="display: flex; gap: 1rem; align-items: center;">
                <label style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer;">
                    <input type="checkbox" id="is_important" style="border-radius: 4px;">
                    <span style="font-size: 0.875rem; font-weight: 500;">‚òÖ Important</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer;">
                    <input type="checkbox" id="is_pinned" style="border-radius: 4px;">
                    <span style="font-size: 0.875rem; font-weight: 500;">üìå √âpingler</span>
                </label>
            </div>
            
            <button onclick="publishNews()" class="btn-primary" style="padding: 0.625rem 1.5rem;">
                Publier
            </button>
        </div>
    </div>

    <!-- Filtres -->
    <div style="margin-bottom: 1.5rem;">
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button onclick="filterByCategory('')" id="filter-all" class="btn-filter" style="padding: 0.5rem 1rem; border: 2px solid #667eea; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; background: #667eea; color: white; transition: all 0.2s;">
                Toutes
            </button>
            <button onclick="filterByCategory('info')" id="filter-info" class="btn-filter" style="padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; background: white; color: #6b7280; transition: all 0.2s;">
                Info
            </button>
            <button onclick="filterByCategory('announcement')" id="filter-announcement" class="btn-filter" style="padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; background: white; color: #6b7280; transition: all 0.2s;">
                Annonce
            </button>
            <button onclick="filterByCategory('warning')" id="filter-warning" class="btn-filter" style="padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; background: white; color: #6b7280; transition: all 0.2s;">
                Alerte
            </button>
            <button onclick="filterByCategory('maintenance')" id="filter-maintenance" class="btn-filter" style="padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; background: white; color: #6b7280; transition: all 0.2s;">
                Travaux
            </button>
        </div>
    </div>

    <!-- Fil d'actualit√©s -->
    <div id="news-feed">
        <div style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
            <p style="color: #9ca3af;">Aucune actualit√© pour le moment</p>
        </div>
    </div>
</div>

<style>
.btn-filter:hover {
    background: #f3f4f6 !important;
}

.btn-filter.active {
    background: #667eea !important;
    color: white !important;
    border-color: #667eea !important;
}
</style>
{% endblock %}

{% block admin_extra_js %}
<script>
let allNews = [];
let currentCategory = '';

async function loadResidences() {
    try {
        const response = await fetch('/api/admin/residences');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('residence_id');
            select.innerHTML = '<option value="">S√©lectionner une r√©sidence...</option>';
            data.residences.forEach(res => {
                select.innerHTML += `<option value="${res.id}">${res.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadNews() {
    try {
        const response = await fetch('/api/admin/news');
        const data = await response.json();
        
        if (data.success) {
            allNews = data.news || [];
            filterByCategory(currentCategory);
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

function filterByCategory(category) {
    currentCategory = category;
    
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = category ? document.getElementById(`filter-${category}`) : document.getElementById('filter-all');
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    const filtered = category ? allNews.filter(n => n.category === category) : allNews;
    displayNews(filtered);
}

function displayNews(newsList) {
    const container = document.getElementById('news-feed');
    
    if (newsList.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p style="color: #9ca3af;">Aucune actualit√© dans cette cat√©gorie</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = newsList.map(news => {
        const categoryEmoji = {
            'info': '‚ÑπÔ∏è',
            'announcement': 'üì¢',
            'warning': '‚ö†Ô∏è',
            'maintenance': 'üîß'
        };
        
        return `
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            ${news.is_pinned ? '<span style="font-size: 1.125rem;">üìå</span>' : ''}
                            ${news.is_important ? '<span style="font-size: 1.125rem;">‚òÖ</span>' : ''}
                            <span style="background: #f3f4f6; padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                ${categoryEmoji[news.category] || '‚ÑπÔ∏è'} ${news.category}
                            </span>
                        </div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem;">${news.title}</h3>
                        <p style="color: #6b7280; font-size: 0.875rem; line-height: 1.5;">${news.content}</p>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                    <div style="font-size: 0.75rem; color: #9ca3af;">
                        ${news.residence_name || 'Toutes les r√©sidences'} ‚Ä¢ ${new Date(news.published_at || news.created_at).toLocaleDateString('fr-FR')}
                    </div>
                    <button onclick="deleteNews(${news.id})" style="padding: 0.375rem 0.75rem; color: #dc2626; border: 1px solid #fca5a5; border-radius: 6px; font-size: 0.8125rem; cursor: pointer; background: white; transition: all 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='white'">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function publishNews() {
    const residenceId = document.getElementById('residence_id').value;
    const title = document.getElementById('news-title').value.trim();
    const content = document.getElementById('news-content').value.trim();
    const isImportant = document.getElementById('is_important').checked;
    const isPinned = document.getElementById('is_pinned').checked;
    
    if (!residenceId) {
        MySindic.showToast('Veuillez s√©lectionner une r√©sidence', 'error');
        return;
    }
    
    if (!title || !content) {
        MySindic.showToast('Veuillez remplir le titre et le contenu', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/news', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                residence_id: parseInt(residenceId),
                title,
                content,
                category: 'info',
                is_important: isImportant,
                is_pinned: isPinned,
                is_published: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast('Actualit√© publi√©e!', 'success');
            document.getElementById('news-title').value = '';
            document.getElementById('news-content').value = '';
            document.getElementById('is_important').checked = false;
            document.getElementById('is_pinned').checked = false;
            loadNews();
        } else {
            MySindic.showToast(data.error || 'Erreur lors de la publication', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

async function deleteNews(newsId) {
    if (!confirm('Supprimer cette actualit√©?')) return;
    
    try {
        const response = await fetch(`/api/admin/news/${newsId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast('Actualit√© supprim√©e', 'success');
            loadNews();
        } else {
            MySindic.showToast(data.error || 'Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadResidences();
    loadNews();
});
</script>
{% endblock %}
