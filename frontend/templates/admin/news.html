<!--
MySindic - Solution compl√®te et digitale pour les syndics et r√©sidents au Maroc.

Shabaka Syndic
Par : Aisance KALONJI
Mail : moa@myoneart.com
www.myoneart.com
-->
{% extends "admin/admin_base.html" %}

{% block title %}Actualit√©s - MySindic{% endblock %}

{% block admin_content %}
<div class="content-card">
    <div class="card-header">
        <div>
            <h1 class="page-title">üì∞ Fil d'Actualit√©</h1>
            <p class="page-subtitle">G√©rez les actualit√©s par r√©sidence</p>
        </div>
    </div>

    <!-- Filtre par r√©sidence -->
    <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
            üè¢ R√©sidence
        </label>
        <select id="residence-filter" onchange="onResidenceChange()" style="width: 100%; max-width: 400px; padding: 0.625rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.875rem; background: white; outline: none; cursor: pointer;">
            <option value="">S√©lectionner une r√©sidence...</option>
        </select>
    </div>

    <!-- Zone de publication (visible uniquement si r√©sidence s√©lectionn√©e) -->
    <div id="publish-section" style="display: none; margin-bottom: 2rem;">
        <div style="background: white; border: 2px solid #667eea; border-radius: 16px; padding: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <span style="font-size: 1.25rem;">üìù</span>
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #111827;">Fil d'Actualit√©</h3>
            </div>
            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Derni√®res nouvelles de votre r√©sidence</p>
            
            <textarea id="news-content" placeholder="Quoi de neuf ?" style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 0.9375rem; resize: vertical; min-height: 100px; outline: none; background: #f9fafb; margin-bottom: 0.75rem;"></textarea>
            
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button onclick="MySindic.showToast('Fonctionnalit√© √† venir', 'info')" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: white; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <span>üñºÔ∏è</span> Photo
                    </button>
                    <button onclick="MySindic.showToast('Fonctionnalit√© √† venir', 'info')" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: white; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <span>üé•</span> Vid√©o
                    </button>
                    <button onclick="MySindic.showToast('Fonctionnalit√© √† venir', 'info')" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: white; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <span>üòä</span> Emoji
                    </button>
                    <button onclick="toggleAdvancedOptions()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: white; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <span>‚öôÔ∏è</span> Format
                    </button>
                </div>
                
                <button onclick="publishNews()" style="padding: 0.625rem 2rem; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
                    Publier
                </button>
            </div>
            
            <!-- Options avanc√©es -->
            <div id="advanced-options" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="is_important" style="width: 1.125rem; height: 1.125rem; border-radius: 4px; cursor: pointer;">
                        <span style="font-size: 0.875rem; font-weight: 500;">‚≠ê Important</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="is_pinned" style="width: 1.125rem; height: 1.125rem; border-radius: 4px; cursor: pointer;">
                        <span style="font-size: 0.875rem; font-weight: 500;">üìå √âpingler</span>
                    </label>
                    
                    <select id="category" style="padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white; outline: none; cursor: pointer;">
                        <option value="info">‚ÑπÔ∏è Info</option>
                        <option value="announcement">üì¢ Annonce</option>
                        <option value="warning">‚ö†Ô∏è Alerte</option>
                        <option value="maintenance">üîß Travaux</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Message si aucune r√©sidence s√©lectionn√©e -->
    <div id="no-residence-message" style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 12px; border: 2px dashed #e5e7eb;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üè¢</div>
        <p style="color: #6b7280; font-size: 1rem; font-weight: 500;">S√©lectionnez une r√©sidence pour voir son fil d'actualit√©</p>
    </div>

    <!-- Fil d'actualit√©s -->
    <div id="news-feed" style="display: none;">
        <div style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
            <p style="color: #9ca3af;">Aucune actualit√© pour le moment</p>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
let allNews = [];
let selectedResidenceId = null;

function toggleAdvancedOptions() {
    const options = document.getElementById('advanced-options');
    options.style.display = options.style.display === 'none' ? 'block' : 'none';
}

async function loadResidences() {
    try {
        const response = await fetch('/api/admin/residences');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('residence-filter');
            select.innerHTML = '<option value="">S√©lectionner une r√©sidence...</option>';
            data.residences.forEach(res => {
                select.innerHTML += `<option value="${res.id}">${res.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function onResidenceChange() {
    const select = document.getElementById('residence-filter');
    selectedResidenceId = select.value ? parseInt(select.value) : null;
    
    if (selectedResidenceId) {
        document.getElementById('publish-section').style.display = 'block';
        document.getElementById('no-residence-message').style.display = 'none';
        loadNews();
    } else {
        document.getElementById('publish-section').style.display = 'none';
        document.getElementById('news-feed').style.display = 'none';
        document.getElementById('no-residence-message').style.display = 'block';
    }
}

async function loadNews() {
    if (!selectedResidenceId) return;
    
    try {
        const response = await fetch('/api/admin/news');
        const data = await response.json();
        
        if (data.success) {
            allNews = data.news.filter(n => n.residence_id === selectedResidenceId);
            displayNews(allNews);
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

function displayNews(newsList) {
    const container = document.getElementById('news-feed');
    container.style.display = 'block';
    
    if (newsList.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 12px; margin-top: 1rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p style="color: #9ca3af; font-size: 0.9375rem;">Aucune actualit√© pour le moment</p>
                <p style="color: #d1d5db; font-size: 0.8125rem; margin-top: 0.5rem;">Publiez la premi√®re actualit√© de cette r√©sidence</p>
            </div>
        `;
        return;
    }
    
    const pinnedNews = newsList.filter(n => n.is_pinned).sort((a, b) => new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at));
    const regularNews = newsList.filter(n => !n.is_pinned).sort((a, b) => new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at));
    
    let html = '<div style="margin-top: 1.5rem;">';
    
    if (pinnedNews.length > 0) {
        html += '<div style="margin-bottom: 2rem;"><h3 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem;">üìå Actualit√©s √©pingl√©es</h3>';
        html += pinnedNews.map(news => createNewsCard(news, true)).join('');
        html += '</div>';
    }
    
    if (regularNews.length > 0) {
        if (pinnedNews.length > 0) {
            html += '<h3 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem;">Actualit√©s r√©centes</h3>';
        }
        html += regularNews.map(news => createNewsCard(news, false)).join('');
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function createNewsCard(news, isPinned) {
    const categoryEmoji = {
        'info': '‚ÑπÔ∏è',
        'announcement': 'üì¢',
        'warning': '‚ö†Ô∏è',
        'maintenance': 'üîß'
    };
    
    const categoryColor = {
        'info': '#3b82f6',
        'announcement': '#10b981',
        'warning': '#f59e0b',
        'maintenance': '#ef4444'
    };
    
    const date = new Date(news.published_at || news.created_at);
    const formattedDate = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    
    return `
        <div style="background: white; border: 2px solid ${isPinned ? '#a5b4fc' : '#e5e7eb'}; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; ${isPinned ? 'background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);' : ''}">
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <div style="flex-shrink: 0; font-size: 2.5rem;">
                    ${categoryEmoji[news.category] || '‚ÑπÔ∏è'}
                </div>
                <div style="flex: 1;">
                    <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem; margin-bottom: 0.75rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                ${news.is_important ? '<span style="color: #ef4444; font-size: 1.25rem;">‚≠ê</span>' : ''}
                                ${news.is_pinned ? '<span style="font-size: 1rem;">üìå</span>' : ''}
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; background: ${categoryColor[news.category] || '#3b82f6'}20; color: ${categoryColor[news.category] || '#3b82f6'};">
                                    ${news.category || 'info'}
                                </span>
                            </div>
                            <p style="color: #111827; font-size: 0.9375rem; line-height: 1.6; white-space: pre-wrap;">${news.content}</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                        <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.8125rem; color: #9ca3af;">
                            <span>üìÖ ${formattedDate}</span>
                            ${news.author_name ? `<span>‚úçÔ∏è ${news.author_name}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editNews(${news.id})" style="padding: 0.5rem 0.875rem; color: #667eea; border: 1px solid #667eea; border-radius: 8px; font-size: 0.8125rem; font-weight: 600; cursor: pointer; background: white; transition: all 0.2s;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='white'">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="deleteNews(${news.id})" style="padding: 0.5rem 0.875rem; color: #dc2626; border: 1px solid #fca5a5; border-radius: 8px; font-size: 0.8125rem; font-weight: 600; cursor: pointer; background: white; transition: all 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='white'">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function publishNews() {
    if (!selectedResidenceId) {
        MySindic.showToast('Veuillez s√©lectionner une r√©sidence', 'error');
        return;
    }
    
    const content = document.getElementById('news-content').value.trim();
    const isImportant = document.getElementById('is_important').checked;
    const isPinned = document.getElementById('is_pinned').checked;
    const category = document.getElementById('category').value;
    
    if (!content) {
        MySindic.showToast('Veuillez √©crire un message', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/news', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                residence_id: selectedResidenceId,
                title: content.substring(0, 100),
                content: content,
                category: category,
                is_important: isImportant,
                is_pinned: isPinned,
                is_published: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast('Actualit√© publi√©e !', 'success');
            document.getElementById('news-content').value = '';
            document.getElementById('is_important').checked = false;
            document.getElementById('is_pinned').checked = false;
            document.getElementById('category').value = 'info';
            document.getElementById('advanced-options').style.display = 'none';
            loadNews();
        } else {
            MySindic.showToast(data.error || 'Erreur lors de la publication', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

async function editNews(newsId) {
    MySindic.showToast('Fonctionnalit√© de modification √† venir', 'info');
}

async function deleteNews(newsId) {
    if (!confirm('Supprimer cette actualit√© ?')) return;
    
    try {
        const response = await fetch(`/api/admin/news/${newsId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast('Actualit√© supprim√©e', 'success');
            loadNews();
        } else {
            MySindic.showToast(data.error || 'Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadResidences();
});
</script>
{% endblock %}
