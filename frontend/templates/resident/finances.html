<!--
MySindic - Solution compl√®te et digitale pour les syndics et r√©sidents au Maroc.

Shabaka Syndic
Par : Aisance KALONJI
Mail : moa@myoneart.com
www.myoneart.com
-->
{% extends "base.html" %}

{% block title %}Mes Finances - MySindic{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-gray-900">Mes Finances</h1>
            <p class="mt-2 text-sm text-gray-700">Charges et paiements de mon lot</p>
        </div>
        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
            <button onclick="MySindic.openModal('paymentModal')" class="btn-primary">
                D√©clarer un Paiement
            </button>
        </div>
    </div>

    <div class="mt-8 grid grid-cols-1 gap-6 sm:grid-cols-3">
        <div class="stat-card">
            <div class="stat-card-icon">üí∞</div>
            <div class="stat-card-title">Mon solde</div>
            <div class="stat-card-value" id="stat-balance">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-icon">üìã</div>
            <div class="stat-card-title">Charges impay√©es</div>
            <div class="stat-card-value text-red-600" id="stat-unpaid">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-icon">‚úÖ</div>
            <div class="stat-card-title">Paiements en attente</div>
            <div class="stat-card-value text-yellow-600" id="stat-pending">-</div>
        </div>
    </div>

    <div class="mt-8">
        <div class="tab-list">
            <button onclick="switchTab('charges')" id="tab-charges" class="tab-button tab-button-active">
                Mes Charges
            </button>
            <button onclick="switchTab('payments')" id="tab-payments" class="tab-button tab-button-inactive">
                Mes Paiements
            </button>
        </div>

        <div id="tab-content-charges" class="card mt-4">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Liste de mes charges</h3>
            <div id="charges-list" class="overflow-x-auto">
                <div class="flex justify-center py-8">
                    <div class="loading-spinner border-indigo-600"></div>
                </div>
            </div>
        </div>

        <div id="tab-content-payments" class="card mt-4 hidden">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Historique de mes paiements</h3>
            <div id="payments-list" class="overflow-x-auto">
                <div class="flex justify-center py-8">
                    <div class="loading-spinner border-indigo-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal D√©clarer Paiement -->
<div id="paymentModal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">D√©clarer un Paiement</h2>
                <button onclick="MySindic.closeModal('paymentModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="paymentForm" class="space-y-4">
                <div>
                    <label class="label-field">Montant (MAD) *</label>
                    <input type="number" id="payment-amount" class="input-field" step="0.01" required>
                </div>
                
                <div>
                    <label class="label-field">Date du paiement *</label>
                    <input type="date" id="payment-date" class="input-field" required>
                </div>
                
                <div>
                    <label class="label-field">M√©thode de paiement *</label>
                    <select id="payment-method" class="input-field" required>
                        <option value="">S√©lectionner</option>
                        <option value="bank_transfer">Virement bancaire</option>
                        <option value="check">Ch√®que</option>
                        <option value="cash">Esp√®ces</option>
                        <option value="online">Paiement en ligne</option>
                    </select>
                </div>
                
                <div>
                    <label class="label-field">R√©f√©rence</label>
                    <input type="text" id="payment-reference" class="input-field" placeholder="Num√©ro de ch√®que, r√©f√©rence de virement...">
                </div>
                
                <div>
                    <label class="label-field">Description</label>
                    <textarea id="payment-description" class="input-field" rows="2" placeholder="Notes additionnelles (optionnel)"></textarea>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex">
                        <svg class="h-5 w-5 text-yellow-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                Votre paiement sera valid√© par l'administration. Conservez vos justificatifs.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="MySindic.closeModal('paymentModal')" class="btn-secondary">
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary">
                        D√©clarer le paiement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let myCharges = [];
let myPayments = [];
let balance = 0;

async function loadFinancialData() {
    try {
        const [chargesRes, paymentsRes, balanceRes] = await Promise.all([
            fetch('/api/resident/charges'),
            fetch('/api/resident/payments'),
            fetch('/api/resident/balance')
        ]);
        
        const chargesData = await chargesRes.json();
        const paymentsData = await paymentsRes.json();
        const balanceData = await balanceRes.json();
        
        if (chargesData.success) {
            myCharges = chargesData.charges;
            displayCharges();
        }
        
        if (paymentsData.success) {
            myPayments = paymentsData.payments;
        }
        
        if (balanceData.success) {
            balance = balanceData.balance;
            updateStats();
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur lors du chargement', 'error');
    }
}

function updateStats() {
    const balanceEl = document.getElementById('stat-balance');
    balanceEl.textContent = MySindic.formatCurrency(Math.abs(balance));
    balanceEl.classList.add(balance < 0 ? 'text-red-600' : 'text-green-600');
    
    const unpaid = myCharges.filter(c => c.distribution && !c.distribution.is_paid).reduce((sum, c) => sum + parseFloat(c.distribution.amount), 0);
    document.getElementById('stat-unpaid').textContent = MySindic.formatCurrency(unpaid);
    
    const pending = myPayments.filter(p => p.status === 'pending').length;
    document.getElementById('stat-pending').textContent = pending;
}

function displayCharges() {
    const container = document.getElementById('charges-list');
    
    if (myCharges.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune charge trouv√©e</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Type</th>
                    <th>P√©riode</th>
                    <th>Montant</th>
                    <th>√âch√©ance</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                ${myCharges.map(charge => {
                    const dist = charge.distribution;
                    const isPaid = dist && dist.is_paid;
                    
                    return `
                        <tr class="${isPaid ? '' : 'bg-red-50'}">
                            <td>
                                <div class="font-medium text-gray-900">${charge.title}</div>
                                ${charge.description ? `<div class="text-sm text-gray-500">${charge.description.substring(0, 50)}...</div>` : ''}
                            </td>
                            <td><span class="badge badge-info">${charge.charge_type}</span></td>
                            <td>${charge.period_month ? charge.period_month + '/' : ''}${charge.period_year}</td>
                            <td class="font-semibold">${dist ? MySindic.formatCurrency(dist.amount) : '-'}</td>
                            <td class="text-sm">${charge.due_date ? MySindic.formatDate(charge.due_date) : '-'}</td>
                            <td>
                                ${isPaid ? 
                                    '<span class="badge badge-success">Pay√©e</span>' :
                                    '<span class="badge badge-danger">Impay√©e</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

async function loadPayments() {
    const container = document.getElementById('payments-list');
    
    if (myPayments.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Aucun paiement enregistr√©</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>M√©thode</th>
                    <th>R√©f√©rence</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                ${myPayments.map(p => `
                    <tr>
                        <td>${MySindic.formatDate(p.payment_date)}</td>
                        <td class="font-semibold text-green-600">${MySindic.formatCurrency(p.amount)}</td>
                        <td><span class="badge badge-info">${p.payment_method}</span></td>
                        <td class="text-sm">${p.reference || '-'}</td>
                        <td>
                            <span class="badge ${p.status === 'validated' ? 'badge-success' : p.status === 'pending' ? 'badge-warning' : 'badge-danger'}">
                                ${p.status}
                            </span>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('tab-button-active');
        btn.classList.add('tab-button-inactive');
    });
    
    document.getElementById(`tab-${tab}`).classList.remove('tab-button-inactive');
    document.getElementById(`tab-${tab}`).classList.add('tab-button-active');
    
    document.getElementById('tab-content-charges').classList.toggle('hidden', tab !== 'charges');
    document.getElementById('tab-content-payments').classList.toggle('hidden', tab !== 'payments');
    
    if (tab === 'payments' && document.getElementById('payments-list').innerHTML.includes('loading-spinner')) {
        loadPayments();
    }
}

document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        amount: parseFloat(document.getElementById('payment-amount').value),
        payment_date: document.getElementById('payment-date').value,
        payment_method: document.getElementById('payment-method').value,
        reference: document.getElementById('payment-reference').value,
        description: document.getElementById('payment-description').value
    };
    
    try {
        const response = await fetch('/api/resident/payments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            MySindic.showToast('Paiement d√©clar√© avec succ√®s', 'success');
            MySindic.closeModal('paymentModal');
            document.getElementById('paymentForm').reset();
            
            const paymentsRes = await fetch('/api/resident/payments');
            const paymentsData = await paymentsRes.json();
            if (paymentsData.success) {
                myPayments = paymentsData.payments;
                updateStats();
                if (!document.getElementById('tab-content-payments').classList.contains('hidden')) {
                    loadPayments();
                }
            }
        } else {
            MySindic.showToast(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        MySindic.showToast('Erreur de connexion', 'error');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    loadFinancialData();
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payment-date').value = today;
});
</script>
{% endblock %}
